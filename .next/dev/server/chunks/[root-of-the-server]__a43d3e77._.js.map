{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/deepakkumar/Downloads/code/lib/mongodb.ts"],"sourcesContent":["import { MongoClient, Db } from 'mongodb';\n\nconst uri: string = process.env.MONGODB_URI || '';\n\nif (!uri) {\n  console.error('MONGODB_URI is not set. Please add your Mongo URI to .env.local');\n}\n\nconst options = {\n  maxPoolSize: 10,\n  serverSelectionTimeoutMS: 10000, // Increased timeout\n  socketTimeoutMS: 45000,\n  connectTimeoutMS: 10000,\n};\n\nlet client: MongoClient;\nlet clientPromise: Promise<MongoClient>;\n\n// Initialize connection only if URI is available\nif (uri) {\n  if (process.env.NODE_ENV === 'development') {\n    // In development mode, use a global variable so that the value\n    // is preserved across module reloads caused by HMR (Hot Module Replacement).\n    let globalWithMongo = global as typeof globalThis & {\n      _mongoClientPromise?: Promise<MongoClient>;\n    };\n\n    if (!globalWithMongo._mongoClientPromise) {\n      try {\n        client = new MongoClient(uri, options);\n        globalWithMongo._mongoClientPromise = client.connect().catch((err) => {\n          // Clear the promise on error so it can be retried\n          globalWithMongo._mongoClientPromise = undefined;\n          throw err;\n        });\n      } catch (err) {\n        console.error('Failed to create MongoDB client:', err);\n        throw err;\n      }\n    }\n    clientPromise = globalWithMongo._mongoClientPromise;\n  } else {\n    // In production mode, it's best to not use a global variable.\n    try {\n      client = new MongoClient(uri, options);\n      clientPromise = client.connect();\n    } catch (err) {\n      console.error('Failed to create MongoDB client:', err);\n      throw err;\n    }\n  }\n} else {\n  // Create a rejected promise if URI is not set\n  clientPromise = Promise.reject(new Error('MongoDB URI is not configured'));\n}\n\n// Export a module-scoped MongoClient promise. By doing this in a\n// separate module, the client can be shared across functions.\nexport default clientPromise;\n\nexport async function getDatabase(): Promise<Db> {\n  // Re-read URI from environment in case it was updated\n  const currentUri = process.env.MONGODB_URI || '';\n  \n  if (!currentUri) {\n    throw new Error('MongoDB URI is not configured. Please set MONGODB_URI in .env.local and restart the server.');\n  }\n\n  try {\n    // Wait for client connection\n    const client = await clientPromise;\n    \n    // Verify client is connected\n    if (!client) {\n      throw new Error('MongoDB client is not initialized');\n    }\n    \n    // Extract database name from URI or use default\n    // URI format: mongodb+srv://user:pass@cluster/dbname?options\n    const dbNameMatch = currentUri.match(/\\/\\/(?:[^@]+@)?[^/]+\\/([^?]+)/);\n    const dbName = dbNameMatch?.[1] || 'rural_healthcare';\n    const db = client.db(dbName);\n    \n    // Test the connection with a simple operation (without admin ping which might fail)\n    // Just return the db - the actual operation will test the connection\n    return db;\n  } catch (error: any) {\n    console.error('MongoDB connection error details:', {\n      message: error.message,\n      name: error.name,\n      code: error.code,\n      errorResponse: error.errorResponse,\n    });\n    \n    // Provide more specific error messages\n    if (error.message?.includes('authentication failed') || error.code === 8000 || error.errorResponse?.code === 8000) {\n      throw new Error('MongoDB authentication failed. Please verify: 1) Username and password in MongoDB Atlas Database Access, 2) User has correct privileges, 3) Connection string in .env.local matches Atlas. Get the connection string from Atlas Dashboard → Connect → Connect your application.');\n    } else if (error.message?.includes('timeout') || error.code === 'ETIMEDOUT') {\n      throw new Error('MongoDB connection timeout. Please check your network connection and firewall settings.');\n    } else if (error.message?.includes('ENOTFOUND') || error.message?.includes('getaddrinfo') || error.code === 'ENOTFOUND') {\n      throw new Error('Cannot reach MongoDB server. Please check your network connection and cluster address.');\n    } else if (error.message?.includes('MongoServerError')) {\n      throw new Error(`MongoDB server error: ${error.message}`);\n    } else {\n      throw new Error(`MongoDB connection failed: ${error.message || 'Unknown error'}. Please check your .env.local file and restart the server.`);\n    }\n  }\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAc,QAAQ,GAAG,CAAC,WAAW,IAAI;AAE/C,IAAI,CAAC,KAAK;IACR,QAAQ,KAAK,CAAC;AAChB;AAEA,MAAM,UAAU;IACd,aAAa;IACb,0BAA0B;IAC1B,iBAAiB;IACjB,kBAAkB;AACpB;AAEA,IAAI;AACJ,IAAI;AAEJ,iDAAiD;AACjD,IAAI,KAAK;IACP,wCAA4C;QAC1C,+DAA+D;QAC/D,6EAA6E;QAC7E,IAAI;QAIJ,IAAI,CAAC,gBAAgB,mBAAmB,EAAE;YACxC,IAAI;gBACF,SAAS,IAAI,sHAAW,CAAC,KAAK;gBAC9B,gBAAgB,mBAAmB,GAAG,OAAO,OAAO,GAAG,KAAK,CAAC,CAAC;oBAC5D,kDAAkD;oBAClD,gBAAgB,mBAAmB,GAAG;oBACtC,MAAM;gBACR;YACF,EAAE,OAAO,KAAK;gBACZ,QAAQ,KAAK,CAAC,oCAAoC;gBAClD,MAAM;YACR;QACF;QACA,gBAAgB,gBAAgB,mBAAmB;IACrD;;AAUF,OAAO;IACL,8CAA8C;IAC9C,gBAAgB,QAAQ,MAAM,CAAC,IAAI,MAAM;AAC3C;uCAIe;AAER,eAAe;IACpB,sDAAsD;IACtD,MAAM,aAAa,QAAQ,GAAG,CAAC,WAAW,IAAI;IAE9C,IAAI,CAAC,YAAY;QACf,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI;QACF,6BAA6B;QAC7B,MAAM,SAAS,MAAM;QAErB,6BAA6B;QAC7B,IAAI,CAAC,QAAQ;YACX,MAAM,IAAI,MAAM;QAClB;QAEA,gDAAgD;QAChD,6DAA6D;QAC7D,MAAM,cAAc,WAAW,KAAK,CAAC;QACrC,MAAM,SAAS,aAAa,CAAC,EAAE,IAAI;QACnC,MAAM,KAAK,OAAO,EAAE,CAAC;QAErB,oFAAoF;QACpF,qEAAqE;QACrE,OAAO;IACT,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,qCAAqC;YACjD,SAAS,MAAM,OAAO;YACtB,MAAM,MAAM,IAAI;YAChB,MAAM,MAAM,IAAI;YAChB,eAAe,MAAM,aAAa;QACpC;QAEA,uCAAuC;QACvC,IAAI,MAAM,OAAO,EAAE,SAAS,4BAA4B,MAAM,IAAI,KAAK,QAAQ,MAAM,aAAa,EAAE,SAAS,MAAM;YACjH,MAAM,IAAI,MAAM;QAClB,OAAO,IAAI,MAAM,OAAO,EAAE,SAAS,cAAc,MAAM,IAAI,KAAK,aAAa;YAC3E,MAAM,IAAI,MAAM;QAClB,OAAO,IAAI,MAAM,OAAO,EAAE,SAAS,gBAAgB,MAAM,OAAO,EAAE,SAAS,kBAAkB,MAAM,IAAI,KAAK,aAAa;YACvH,MAAM,IAAI,MAAM;QAClB,OAAO,IAAI,MAAM,OAAO,EAAE,SAAS,qBAAqB;YACtD,MAAM,IAAI,MAAM,CAAC,sBAAsB,EAAE,MAAM,OAAO,EAAE;QAC1D,OAAO;YACL,MAAM,IAAI,MAAM,CAAC,2BAA2B,EAAE,MAAM,OAAO,IAAI,gBAAgB,2DAA2D,CAAC;QAC7I;IACF;AACF"}},
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file:///Users/deepakkumar/Downloads/code/app/api/auth/signup/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport bcrypt from 'bcryptjs';\nimport { getDatabase } from '@/lib/mongodb';\nimport { UserDocument, Patient, HealthWorker } from '@/lib/models/user';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { role, email, password, ...otherData } = body;\n\n    // Validate required fields\n    if (!email || !password) {\n      return NextResponse.json(\n        { error: 'Email and password are required' },\n        { status: 400 }\n      );\n    }\n\n    if (!['patient', 'health-worker', 'admin'].includes(role)) {\n      return NextResponse.json(\n        { error: 'Invalid role' },\n        { status: 400 }\n      );\n    }\n\n    // Validate password length\n    if (password.length < 6) {\n      return NextResponse.json(\n        { error: 'Password must be at least 6 characters' },\n        { status: 400 }\n      );\n    }\n\n    let db;\n    try {\n      db = await getDatabase();\n    } catch (dbError: any) {\n      console.error('Database connection error:', {\n        message: dbError?.message,\n        code: dbError?.code,\n        errorResponse: dbError?.errorResponse,\n      });\n      \n      let errorMessage = dbError?.message || 'Database connection failed.';\n      \n      // Provide helpful error messages\n      if (dbError?.message?.includes('authentication failed') || dbError?.code === 8000 || dbError?.errorResponse?.code === 8000) {\n        errorMessage = 'MongoDB authentication failed. Please: 1) Verify username/password in MongoDB Atlas → Database Access, 2) Get connection string from Atlas → Connect → Connect your application, 3) Update .env.local and restart server.';\n      } else if (dbError?.message?.includes('timeout')) {\n        errorMessage = 'Connection timeout. Please check your network connection.';\n      }\n      \n      return NextResponse.json(\n        { error: errorMessage },\n        { status: 500 }\n      );\n    }\n    \n    // Test the connection with a simple operation\n    try {\n      await db.admin().ping();\n    } catch (pingError: any) {\n      // If ping fails, try a simple collection operation instead\n      console.log('Admin ping failed, trying collection operation...');\n    }\n    \n    const usersCollection = db.collection<UserDocument>('users');\n\n    // Check if user already exists\n    const existingUser = await usersCollection.findOne({ email });\n    if (existingUser) {\n      return NextResponse.json(\n        { error: 'User with this email already exists' },\n        { status: 400 }\n      );\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(password, 10);\n\n    // Create user document based on role\n    const now = new Date();\n    let userDoc: UserDocument;\n\n    if (role === 'patient') {\n      userDoc = {\n        email,\n        password: hashedPassword,\n        role: 'patient',\n        fullName: otherData.fullName || '',\n        phoneNumber: otherData.phoneNumber,\n        dateOfBirth: otherData.dateOfBirth ? new Date(otherData.dateOfBirth) : undefined,\n        address: otherData.address,\n        createdAt: now,\n        updatedAt: now,\n      } as Patient;\n    } else if (role === 'health-worker') {\n      userDoc = {\n        email,\n        password: hashedPassword,\n        role: 'health-worker',\n        fullName: otherData.fullName || '',\n        phoneNumber: otherData.phoneNumber || '',\n        qualification: otherData.qualification || '',\n        registrationNumber: otherData.registrationNumber || '',\n        hospitalClinicName: otherData.hospitalClinicName || '',\n        district: otherData.district || '',\n        village: otherData.village || '',\n        yearsOfExperience: otherData.yearsOfExperience || '',\n        specializedStream: otherData.specializedStream || '',\n        governmentIdFileName: otherData.governmentIdFileName,\n        proofFileName: otherData.proofFileName,\n        status: 'pending',\n        appliedDate: now,\n        denialReason: undefined,\n        createdAt: now,\n        updatedAt: now,\n      } as HealthWorker;\n    } else {\n      // Admin (for future use)\n      return NextResponse.json(\n        { error: 'Admin registration not allowed through this endpoint' },\n        { status: 403 }\n      );\n    }\n\n    // Insert user into database\n    const result = await usersCollection.insertOne(userDoc);\n\n    // Return success (don't return password)\n    const { password: _, ...userWithoutPassword } = userDoc;\n    \n    return NextResponse.json(\n      {\n        message: 'User created successfully',\n        user: {\n          ...userWithoutPassword,\n          _id: result.insertedId.toString(),\n        },\n      },\n      { status: 201 }\n    );\n  } catch (error) {\n    console.error('Signup error:', error);\n    \n    // Handle JSON parsing errors\n    if (error instanceof SyntaxError) {\n      return NextResponse.json(\n        { error: 'Invalid request data' },\n        { status: 400 }\n      );\n    }\n    \n    // Handle other errors\n    const errorMessage = error instanceof Error ? error.message : 'Internal server error';\n    return NextResponse.json(\n      { error: errorMessage },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAGO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,WAAW,GAAG;QAEhD,2BAA2B;QAC3B,IAAI,CAAC,SAAS,CAAC,UAAU;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAkC,GAC3C;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC;YAAC;YAAW;YAAiB;SAAQ,CAAC,QAAQ,CAAC,OAAO;YACzD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAe,GACxB;gBAAE,QAAQ;YAAI;QAElB;QAEA,2BAA2B;QAC3B,IAAI,SAAS,MAAM,GAAG,GAAG;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyC,GAClD;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI;QACJ,IAAI;YACF,KAAK,MAAM,IAAA,+HAAW;QACxB,EAAE,OAAO,SAAc;YACrB,QAAQ,KAAK,CAAC,8BAA8B;gBAC1C,SAAS,SAAS;gBAClB,MAAM,SAAS;gBACf,eAAe,SAAS;YAC1B;YAEA,IAAI,eAAe,SAAS,WAAW;YAEvC,iCAAiC;YACjC,IAAI,SAAS,SAAS,SAAS,4BAA4B,SAAS,SAAS,QAAQ,SAAS,eAAe,SAAS,MAAM;gBAC1H,eAAe;YACjB,OAAO,IAAI,SAAS,SAAS,SAAS,YAAY;gBAChD,eAAe;YACjB;YAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAa,GACtB;gBAAE,QAAQ;YAAI;QAElB;QAEA,8CAA8C;QAC9C,IAAI;YACF,MAAM,GAAG,KAAK,GAAG,IAAI;QACvB,EAAE,OAAO,WAAgB;YACvB,2DAA2D;YAC3D,QAAQ,GAAG,CAAC;QACd;QAEA,MAAM,kBAAkB,GAAG,UAAU,CAAe;QAEpD,+BAA+B;QAC/B,MAAM,eAAe,MAAM,gBAAgB,OAAO,CAAC;YAAE;QAAM;QAC3D,IAAI,cAAc;YAChB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsC,GAC/C;gBAAE,QAAQ;YAAI;QAElB;QAEA,gBAAgB;QAChB,MAAM,iBAAiB,MAAM,8IAAM,CAAC,IAAI,CAAC,UAAU;QAEnD,qCAAqC;QACrC,MAAM,MAAM,IAAI;QAChB,IAAI;QAEJ,IAAI,SAAS,WAAW;YACtB,UAAU;gBACR;gBACA,UAAU;gBACV,MAAM;gBACN,UAAU,UAAU,QAAQ,IAAI;gBAChC,aAAa,UAAU,WAAW;gBAClC,aAAa,UAAU,WAAW,GAAG,IAAI,KAAK,UAAU,WAAW,IAAI;gBACvE,SAAS,UAAU,OAAO;gBAC1B,WAAW;gBACX,WAAW;YACb;QACF,OAAO,IAAI,SAAS,iBAAiB;YACnC,UAAU;gBACR;gBACA,UAAU;gBACV,MAAM;gBACN,UAAU,UAAU,QAAQ,IAAI;gBAChC,aAAa,UAAU,WAAW,IAAI;gBACtC,eAAe,UAAU,aAAa,IAAI;gBAC1C,oBAAoB,UAAU,kBAAkB,IAAI;gBACpD,oBAAoB,UAAU,kBAAkB,IAAI;gBACpD,UAAU,UAAU,QAAQ,IAAI;gBAChC,SAAS,UAAU,OAAO,IAAI;gBAC9B,mBAAmB,UAAU,iBAAiB,IAAI;gBAClD,mBAAmB,UAAU,iBAAiB,IAAI;gBAClD,sBAAsB,UAAU,oBAAoB;gBACpD,eAAe,UAAU,aAAa;gBACtC,QAAQ;gBACR,aAAa;gBACb,cAAc;gBACd,WAAW;gBACX,WAAW;YACb;QACF,OAAO;YACL,yBAAyB;YACzB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuD,GAChE;gBAAE,QAAQ;YAAI;QAElB;QAEA,4BAA4B;QAC5B,MAAM,SAAS,MAAM,gBAAgB,SAAS,CAAC;QAE/C,yCAAyC;QACzC,MAAM,EAAE,UAAU,CAAC,EAAE,GAAG,qBAAqB,GAAG;QAEhD,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,MAAM;gBACJ,GAAG,mBAAmB;gBACtB,KAAK,OAAO,UAAU,CAAC,QAAQ;YACjC;QACF,GACA;YAAE,QAAQ;QAAI;IAElB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iBAAiB;QAE/B,6BAA6B;QAC7B,IAAI,iBAAiB,aAAa;YAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuB,GAChC;gBAAE,QAAQ;YAAI;QAElB;QAEA,sBAAsB;QACtB,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC9D,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAa,GACtB;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}